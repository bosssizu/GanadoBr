<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>GanadoBravo — Evaluación</title>
<style>
:root{--bg:#f5f7fb;--fg:#0f172a;--muted:#6b7280;--card:#fff;--ok:#16a34a;--bad:#ef4444;}
*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--fg);font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial}
.container{max-width:1120px;margin:24px auto;padding:0 16px}
.grid{display:grid;grid-template-columns:280px 1fr;gap:16px}
.card{background:var(--card);border-radius:14px;box-shadow:0 2px 18px rgba(0,0,0,.06);padding:16px}
.h{margin:0 0 8px 0;font-size:18px}
.small{color:var(--muted);font-size:13px}
.btn{background:#111827;color:#fff;border:0;border-radius:10px;padding:10px 14px;cursor:pointer}
.input{width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:10px}
.kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
.kpi .tile{background:#fff;border:1px solid #eef2f7;border-radius:12px;padding:12px}
.kpi .title{font-size:12px;color:#64748b}
.kpi .value{font-size:20px;margin-top:6px}
.table{width:100%;border-collapse:collapse}
.table th,.table td{padding:10px;border-bottom:1px solid #eef2f7;text-align:left;font-size:14px;vertical-align:top}
.dot{width:10px;height:10px;border-radius:999px;display:inline-block;margin-right:6px}
.dot.ok{background:var(--ok)}.dot.bad{background:var(--bad)}
.list{margin:0;padding-left:18px}
.preview{height:220px;background:#f1f5f9;border:1px dashed #e5e7eb;border-radius:12px;display:flex;align-items:center;justify-content:center}
.preview img{max-height:100%;max-width:100%;object-fit:contain;border-radius:10px}
.footer{color:#9ca3af;font-size:12px;margin-top:10px}
</style>
</head>
<body>
<div class="container">
  <h1 style="margin-bottom:12px;">GanadoBravo — Evaluación</h1>
  <div class="grid">
    <div class="card">
      <h3 class="h">Entrada</h3>
      <div style="margin-bottom:10px">
        <input id="file" type="file" accept="image/*" class="input"/>
      </div>
      <div style="margin-bottom:10px">
        <label class="small">Modo</label>
        <select id="mode" class="input">
          <option value="levante">Levante (default)</option>
          <option value="vaca_flaca">Vaca flaca</option>
          <option value="engorde">Engorde</option>
        </select>
      </div>
      <div class="row" style="display:flex;justify-content:space-between;align-items:center">
        <button class="btn" id="evalBtn">Evaluar</button>
        <span id="modehint" class="small">modo=levante</span>
      </div>
      <div style="height:12px"></div>
      <div class="small">Vista previa</div>
      <div class="preview"><img id="previewImg" alt="vista previa"/></div>
      <div style="height:12px"></div>
      <div class="small">Notas y razones</div>
      <ul class="list" id="reasons"></ul>
      <div class="footer">Diag: <a href="/api/diag" target="_blank">/api/diag</a></div>
    </div>

    <div class="card">
      <h3 class="h">Resultado</h3>
      <div class="kpi" style="margin-top:12px">
        <div class="tile"><div class="title">BCS</div><div class="value" id="k_bcs">—</div></div>
        <div class="tile"><div class="title">Puntaje global</div><div class="value" id="k_global">—</div></div>
        <div class="tile"><div class="title">Riesgo</div><div class="value" id="k_risk">—</div></div>
        <div class="tile"><div class="title">Bono posterior</div><div class="value" id="k_bonus">—</div></div>
      </div>

      <div style="height:10px"></div>
      <div class="small" id="k_decision">Decisión: —</div>

      <div style="height:14px"></div>
      <h3 class="h">Rúbrica detallada</h3>
      <table class="table" id="rubric">
        <thead><tr><th>Métrica</th><th>Puntaje</th><th>Observaciones</th></tr></thead>
        <tbody></tbody>
      </table>

      <div style="height:14px"></div>
      <h3 class="h">Salud</h3>
      <div id="health"></div>

      <div style="height:14px"></div>
      <h3 class="h">Raza</h3>
      <div id="breed" class="small"></div>

      <div style="height:14px"></div>
      <div class="small" id="notes"></div>
    </div>
  </div>
</div>

<script>
// Stable preview using DataURL
let previewData = null;
const fileEl = document.getElementById('file');
const previewImg = document.getElementById('previewImg');

fileEl.addEventListener('change', () => {
  const f = fileEl.files[0];
  if (!f) return;
  const reader = new FileReader();
  reader.onload = (e) => { previewData = e.target.result; previewImg.src = previewData; };
  reader.readAsDataURL(f);
});

document.getElementById('evalBtn').addEventListener('click', evaluate);

function keepPreview(){ if(previewImg && previewData) previewImg.src = previewData; }

async function evaluate(){
  const f = fileEl.files[0];
  if(!f){ alert("Sube una imagen"); return; }
  const modeSel = document.getElementById('mode');
  const mode = modeSel.value;
  document.getElementById('modehint').textContent = `modo=${mode}`;

  const fd = new FormData();
  fd.append('file', f);
  fd.append('mode', mode);

  const res = await fetch('/evaluate', { method:'POST', body: fd });
  keepPreview();
  if(!res.ok){
     alert('Error: '+res.status+' '+await res.text());
     keepPreview();
     return;
  }
  const data = await res.json();
  keepPreview();

  document.getElementById('k_bcs').textContent = (data.bcs??'—');
  document.getElementById('k_global').textContent = (data.global_score??'—');
  document.getElementById('k_risk').textContent = (data.risk??'—');
  document.getElementById('k_bonus').textContent = (data.posterior_bonus??0).toFixed(2);
  document.getElementById('k_decision').textContent = 'Decisión: ' + (data.decision_text || '—');
  document.getElementById('notes').textContent = data.notes || '';

  const rl = document.getElementById('reasons'); rl.innerHTML='';
  (data.reasons||[]).forEach(r => { const li = document.createElement('li'); li.textContent = r; rl.appendChild(li); });

  const tb = document.querySelector('#rubric tbody'); tb.innerHTML='';
  (data.rubric||[]).forEach(r => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.name}</td><td>${Number(r.score).toFixed(2)}</td><td>${r.obs||''}</td>`;
    tb.appendChild(tr);
  });

  const hc = document.getElementById('health'); hc.innerHTML='';
  const ul = document.createElement('ul'); ul.className='list';
  (data.health||[]).forEach(h => {
    const li = document.createElement('li');
    const ok = h.status==='descartado';
    li.innerHTML = `<span class="dot ${ok?'ok':'bad'}"></span>${h.name} = ${ok?'Descartado':'Sospecha'}`;
    ul.appendChild(li);
  });
  hc.appendChild(ul);

  const br = document.getElementById('breed');
  if(data.breed){
    br.textContent = `${data.breed.name||'—'} · conf=${(data.breed.confidence??0).toFixed(2)}${data.breed.explanation?(' — '+data.breed.explanation):''}`;
  } else { br.textContent = '—'; }
}
</script>
</body>
</html>
